// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  passwordHash          String
  name                  String
  role                  Role     @default(STUDENT)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  teacherProfile   Teacher?
  studentProfile   Student?
  accounts         Account[]
  sessions         Session[]
  classMemberships ClassMembership[]
}

enum Role {
  TEACHER
  STUDENT
  ADMIN
}

enum Subject {
  ENGLISH
  MATH
  SCIENCE
  HISTORY
  LANGUAGE
  GENERAL // Default when no subject is selected
}

enum GameMode {
  TRADITIONAL // Standard quiz format
  TOWER_DEFENSE // Phaser tower defense game
  SNAKE // Snake quiz game with colored apples
}

// NextAuth.js models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// USER PROFILES
// ============================================================================

model Teacher {
  id     String  @id @default(cuid())
  userId String  @unique
  school String?
  bio    String? @db.Text

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  pdfs    PDF[]
  games   Game[]
  classes Class[] @relation("TeacherClasses")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Student {
  id     String  @id @default(cuid())
  userId String  @unique
  grade  String?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameSessions GameSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// CLASS MANAGEMENT
// ============================================================================

model Class {
  id          String   @id @default(cuid())
  teacherId   String
  name        String
  description String?  @db.Text
  imageUrl    String?  // Custom class cover image (Vercel Blob URL)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teacher     Teacher           @relation("TeacherClasses", fields: [teacherId], references: [id], onDelete: Cascade)
  memberships ClassMembership[]
  inviteCodes InviteCode[]
  pdfs        PDF[]
  games       Game[]

  @@index([teacherId])
  @@index([isActive])
}

model ClassMembership {
  id       String   @id @default(cuid())
  classId  String
  userId   String
  role     String   @default("student") // For future: student, TA, etc.
  joinedAt DateTime @default(now())

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([classId, userId])
  @@index([classId])
  @@index([userId])
}

model InviteCode {
  id        String   @id @default(cuid())
  classId   String
  code      String   @unique // 6-character alphanumeric code
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  createdBy String // Teacher user ID
  usedCount Int      @default(0) // Track how many students used this code

  // Relations
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([classId, isActive])
}

// ============================================================================
// PDF & CONTENT PROCESSING
// ============================================================================

model PDF {
  id         String   @id @default(cuid())
  teacherId  String
  classId    String
  filename   String
  blobUrl    String // Vercel Blob storage URL
  fileSize   Int
  mimeType   String   @default("application/pdf")
  uploadedAt DateTime @default(now())

  teacher          Teacher           @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class            Class             @relation(fields: [classId], references: [id], onDelete: Cascade)
  processedContent ProcessedContent?
  quizSources      QuizSource[] // Track which quizzes use this PDF

  @@index([teacherId])
  @@index([classId])
}

model ProcessedContent {
  id            String   @id @default(cuid())
  pdfId         String   @unique
  extractedText String   @db.Text
  textLength    Int
  processedAt   DateTime @default(now())

  pdf     PDF    @relation(fields: [pdfId], references: [id], onDelete: Cascade)
  quizzes Quiz[]

  @@index([pdfId])
}

// ============================================================================
// QUIZ & GAME MANAGEMENT
// ============================================================================

model Quiz {
  id                 String   @id @default(cuid())
  processedContentId String
  title              String?
  subject            Subject  @default(GENERAL) // Academic subject for tailored questions
  numQuestions       Int      @default(5)
  quizJson           Json // Store the quiz questions/answers as JSON
  createdAt          DateTime @default(now())

  processedContent ProcessedContent @relation(fields: [processedContentId], references: [id], onDelete: Cascade)
  games            Game[]
  quizSources      QuizSource[] // Track which PDFs were used to generate this quiz

  @@index([processedContentId])
}

// Join table to track which PDFs are used in each quiz
model QuizSource {
  id        String   @id @default(cuid())
  quizId    String
  pdfId     String
  createdAt DateTime @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  pdf  PDF  @relation(fields: [pdfId], references: [id], onDelete: Cascade)

  @@unique([quizId, pdfId])
  @@index([quizId])
  @@index([pdfId])
}

model Game {
  id          String   @id @default(cuid())
  quizId      String
  teacherId   String
  classId     String
  title       String
  description String?  @db.Text
  shareCode   String   @unique // Short code for joining (e.g., "ABC123")
  qrCodeUrl   String? // Vercel Blob URL for QR code image
  isPublic    Boolean  @default(false) // Whether game is publicly discoverable
  wasEverPublic Boolean @default(false) // Track if game was ever made public (for persistent leaderboards)
  gameMode    GameMode @default(TRADITIONAL) // Quiz format (traditional or tower defense)
  active      Boolean  @default(true)
  maxAttempts Int      @default(1) // How many times can a student play
  timeLimit   Int? // Time limit in seconds (optional)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quiz         Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  teacher      Teacher       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  class        Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  gameSessions GameSession[]

  @@index([teacherId])
  @@index([classId])
  @@index([shareCode])
  @@index([active])
  @@index([isPublic])
}

model GameSession {
  id                String    @id @default(cuid())
  gameId            String
  studentId         String? // Optional - null for guest players
  guestName         String? // Name for guest players (required if studentId is null)
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  score             Int?
  totalQuestions    Int?
  correctAnswers    Int?
  timeSpent         Int? // Time spent in seconds
  answersJson       Json? // Store student answers if needed for review
  metadata          Json? // Game-specific statistics (e.g., streak, longest streak, towers built)
  questionResponses Json? // QUESTION ANALYTICS - Detailed per-question data: { "q0": { questionText, selectedAnswer, correctAnswer, correct }, ... }

  game    Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  student Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([gameId])
  @@index([studentId])
}
